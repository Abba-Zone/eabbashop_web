<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment API Test</title>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        form {
            max-width: 500px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .response {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
        }
    </style>
</head>
<script type="text/javascript">
 $(document).ready(function() {      
    const prefix = "testCHC"; // 고정 접두사
    const now = new Date();

    // 날짜와 시간 추출
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const date = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    // 밀리초를 최대 9자리로 패딩하여 추가
    const milliseconds = String(now.getMilliseconds()).padStart(9, '0');
    // 주문번호 조합
    const orderNumber = `${prefix}${year}${month}${date}${hours}${minutes}${seconds}${milliseconds}`;

    $("#ordNo").val(orderNumber);
 });
</script>
<body>
    <form id="paymentForm">
        <label for="ordNo">주문번호 </label>
        <input type="text" id="ordNo" name="ordNo" required>

        <!-- <label for="mkey">MID 암호화키 </label> -->
        <input type="hidden" id="mkey" name="mkey" value="8T2jkQr+E9tFSR23OAM3FMWbQVckSCckK8Xmt8ZfNAAPnLX7nXJg1dg64gJDfZy4QEeFDa24iqABpf9ZmIruGQ==" required>

        <!-- <label for="mid">상점 ID </label> -->
        <input type="hidden" id="mid" name="mid" value="test20007m" required>

        <label for="goodsAmt">승인금액 </label>
        <input type="number" id="goodsAmt" name="goodsAmt" value="15000" required>

        <label for="cardNo">카드번호 </label>
        <input type="text" id="cardNo" name="cardNo" value="9436468727555025" required>

        <label for="expireYymm">카드 유효기간 </label>
        <input type="text" id="expireYymm" name="expireYymm" value="3107" required>

        <label for="quotaMon">할부기간</label>
        <input type="text" id="quotaMon" name="quotaMon" value="00" required>

        <label for="buyer_nm">구매자명</label>
        <input type="text" id="buyer_nm" name="buyer_nm" value="test" required>

        <label for="goodsNm">상품명</label>
        <input type="text" id="goodsNm" name="goodsNm" value="결제테스트" required>

        <label for="ordHp">구매자 휴대폰 번호</label>
        <input type="text" id="ordHp" name="ordHp" value="01064917318" required>

        <button type="button" onclick="submitForm()">Submit</button>
    </form>

    <div id="response" class="response"></div>

    <script>
        async function sha256(message) {
            // 문자열을 Uint8Array로 변환
            const msgBuffer = new TextEncoder().encode(message);

            // SHA256 해시 계산
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);

            // ArrayBuffer를 Hex 문자열로 변환
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        async function submitForm() {
            const form = document.getElementById('paymentForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Save parameters to file
            await saveToFile(data,$("#ordNo").val());

            // SHA256 해시키 생성
            const hashMessage = data.mid + data.goodsAmt;
            data.hashKey = await sha256(hashMessage);


            try {
                const response = await fetch('https://staging-pgapi.korpay.com/api/test/payAppTest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                document.getElementById('response').style.display = 'block';
                document.getElementById('response').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('response').style.display = 'block';
                document.getElementById('response').textContent = `Error: ${error.message}`;
            }
        }
        
        async function saveToFile(data, _filename) {    
            const filename = `${_filename}.txt`;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
